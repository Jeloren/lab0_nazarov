Turbo Assembler	 Version 5.0	    11-19-25 15:31:12	    Page 1
lab_9.asm



      1					 ; lab9.asm
      2					 ; Вариант 10: Установка задержки и скорости повтора+
      3					 клавиатуры
      4					 include lab_9.inc
1     5					 ; lab9.inc
1     6					 ; Константы и импорты
1     7
1     8					 includelib import32.lib
1     9
1    10					 ; --- Константы Win32	API ---
1    11		  =-000A		 STD_INPUT_HANDLE    EQU -10
1    12		  =-000B		 STD_OUTPUT_HANDLE   EQU -11
1    13		  =0000			 NULL		     EQU 0
1    14
1    15					 ; Константы для настройки	клавиатуры
1    16		  =000B			 SPI_SETKEYBOARDSPEED EQU 000Bh	; (11) Скорость	повтора
1    17		  =0017			 SPI_SETKEYBOARDDELAY EQU 0017h	; (23) Задержка	перед первым		    +
     18					 повтором
1    19		  =0002			 SPIF_SENDCHANGE      EQU 0002h	; Обновить системные настройки    +
     20					 немедленно
1    21
1    22					 ; --- Импорт функций ---
1    23					 extrn ExitProcess:near
1    24					 extrn GetStdHandle:near
1    25					 extrn WriteConsoleA:near
1    26					 extrn ReadConsoleA:near
1    27					 extrn SystemParametersInfoA:near ; Находится в User32.dll
1    28
1    29					 ; Псевдонимы	для удобства	(как	в методичке [cite: 88])
1    30					 WriteConsole EQU WriteConsoleA
1    31					 ReadConsole  EQU ReadConsoleA
1    32					 SystemParametersInfo EQU SystemParametersInfoA
     33
     34					 .386
     35	00000000			 .model	FLAT, STDCALL
     36
     37	00000000			 .DATA
     38					     ; Сообщения пользователю
     39	00000000  4C 61	62 20 39 2C 20+	     msgTitle	 DB "Lab 9, Var	10: Keyboard Control", 0Dh, 0Ah, 0
     40		  56 61	72 20 31 30 3A+
     41		  20 4B	65 79 62 6F 61+
     42		  72 64	20 43 6F 6E 74+
     43		  72 6F	6C 0D 0A 00
     44	00000022  0D 0A	45 6E 74 65 72+	     msgDelay	 DB 0Dh, 0Ah, "Enter Delay (0=250ms to 3=1sec):	", 0
     45		  20 44	65 6C 61 79 20+
     46		  28 30	3D 32 35 30 6D+
     47		  73 20	74 6F 20 33 3D+
     48		  31 73	65 63 29 3A 20+
     49		  00
     50	00000046  45 6E	74 65 72 20 53+	     msgSpeed	 DB "Enter Speed (0=Slow to 31=Fast): ", 0
     51		  70 65	65 64 20 28 30+
     52		  3D 53	6C 6F 77 20 74+
     53		  6F 20	33 31 3D 46 61+
     54		  73 74	29 3A 20 00
     55	00000068  0D 0A	53 65 74 74 69+	     msgDone	 DB 0Dh, 0Ah, "Settings	applied	successfully!",	0Dh, 0Ah, 0
     56		  6E 67	73 20 61 70 70+
     57		  6C 69	65 64 20 73 75+
Turbo Assembler	 Version 5.0	    11-19-25 15:31:12	    Page 2
lab_9.asm



     58		  63 63	65 73 73 66 75+
     59		  6C 6C	79 21 0D 0A 00
     60	0000008B  0D 0A	45 72 72 6F 72+	     msgError	 DB 0Dh, 0Ah, "Error applying settings.", 0Dh, 0Ah, 0
     61		  20 61	70 70 6C 79 69+
     62		  6E 67	20 73 65 74 74+
     63		  69 6E	67 73 2E 0D 0A+
     64		  00
     65
     66					     ; Буферы
     67	000000A8  ????????		     hStdOut	 DD ?
     68	000000AC  ????????		     hStdIn	 DD ?
     69	000000B0  0A*(00)		     ReadBuf	 DB 10 DUP(0)
     70	000000BA  ????????		     BytesRead	 DD ?
     71	000000BE  ????????		     BytesWritten DD ?
     72
     73					     ; Переменные для хранения введенных чисел
     74	000000C2  ????????		     ValDelay	 DD ?
     75	000000C6  ????????		     ValSpeed	 DD ?
     76
     77	000000CA			 .CODE
     78	00000000			 Start:
     79					     ; 1. Получение дескрипторов ввода и вывода [cite:	11, +
     80					 193]
     81	00000000  6A F5			     PUSH STD_OUTPUT_HANDLE
     82	00000002  E8 00000000e		     CALL GetStdHandle
     83	00000007  A3 000000A8r		     MOV hStdOut, EAX
     84
     85	0000000C  6A F6			     PUSH STD_INPUT_HANDLE
     86	0000000E  E8 00000000e		     CALL GetStdHandle
     87	00000013  A3 000000ACr		     MOV hStdIn, EAX
     88
     89					     ; 2. Вывод заголовка
     90	00000018  68 00000000r		     PUSH OFFSET msgTitle
     91	0000001D  E8 0000007C		     CALL PrintStr
     92
     93					     ; ---------------------------------------------------------
     94					     ; 3. Ввод и установка ЗАДЕРЖКИ (Delay)
     95					     ; ---------------------------------------------------------
     96	00000022  68 00000022r		     PUSH OFFSET msgDelay
     97	00000027  E8 00000072		     CALL PrintStr
     98
     99	0000002C  E8 00000093		     CALL ReadNum	 ; Читаем	число в EAX
    100	00000031  A3 000000C2r		     MOV ValDelay, EAX	 ; Сохраняем
    101
    102					     ; Вызов SystemParametersInfo для Delay
    103					     ; BOOL SystemParametersInfoA(uiAction, uiParam, pvParam, fWinIni);
    104	00000036  6A 02			     PUSH SPIF_SENDCHANGE      ; Обновить сразу
    105	00000038  6A 00			     PUSH NULL		       ; pvParam (не используется	для этой	    +
    106					 команды)
    107	0000003A  FF 35	000000C2r	     PUSH ValDelay	       ; uiParam (наше значение 0-3)
    108	00000040  6A 17			     PUSH SPI_SETKEYBOARDDELAY ; uiAction
    109	00000042  E8 00000000e		     CALL SystemParametersInfo
    110
    111	00000047  83 F8	00		     CMP EAX, 0
    112	0000004A  74 41	90 90 90 90	     JE	ShowError	       ; Если вернул 0 - ошибка
    113
    114					     ; ---------------------------------------------------------
Turbo Assembler	 Version 5.0	    11-19-25 15:31:12	    Page 3
lab_9.asm



    115					     ; 4. Ввод и установка СКОРОСТИ (Speed)
    116					     ; ---------------------------------------------------------
    117	00000050  68 00000046r		     PUSH OFFSET msgSpeed
    118	00000055  E8 00000044		     CALL PrintStr
    119
    120	0000005A  E8 00000065		     CALL ReadNum	 ; Читаем	число в EAX
    121	0000005F  A3 000000C6r		     MOV ValSpeed, EAX	 ; Сохраняем
    122
    123					     ; Вызов SystemParametersInfo для Speed
    124	00000064  6A 02			     PUSH SPIF_SENDCHANGE
    125	00000066  6A 00			     PUSH NULL
    126	00000068  FF 35	000000C6r	     PUSH ValSpeed	       ; uiParam (наше значение 0-31)
    127	0000006E  6A 0B			     PUSH SPI_SETKEYBOARDSPEED ; uiAction
    128	00000070  E8 00000000e		     CALL SystemParametersInfo
    129
    130	00000075  83 F8	00		     CMP EAX, 0
    131	00000078  74 13	90 90 90 90	     JE	ShowError
    132
    133					     ; 5. Успешное завершение
    134	0000007E  68 00000068r		     PUSH OFFSET msgDone
    135	00000083  E8 00000016		     CALL PrintStr
    136	00000088  EB 0D	90 90 90	     JMP ExitApp
    137
    138	0000008D			 ShowError:
    139	0000008D  68 0000008Br		     PUSH OFFSET msgError
    140	00000092  E8 00000007		     CALL PrintStr
    141
    142	00000097			 ExitApp:
    143	00000097  6A 00			     PUSH 0
    144	00000099  E8 00000000e		     CALL ExitProcess
    145
    146					 ; ---------------------------------------------------------
    147					 ; ПРОЦЕДУРА: PrintStr
    148					 ; Выводит строку,	адрес которой лежит в	стеке или   +
    149					 передается через переменную
    150					 ; В данном упрощенном	варианте ожидает	смещение в +
    151					 стеке перед вызовом
    152					 ; НО	для простоты	используем передачу через PUSH +	    +
    153					 регистры внутри макро/вызова
    154					 ; Чтобы соответствовать стилю:
    155					 ; Вход: В	стеке адрес строки (push offset	String)
    156					 ; ---------------------------------------------------------
    157	0000009E			 PrintStr PROC
    158	0000009E  59			     POP ECX	     ; Адрес возврата
    159	0000009F  5E			     POP ESI	     ; Адрес строки
    160	000000A0  51			     PUSH ECX	     ; Вернули адрес возврата
    161
    162					     ; Подсчет длины строки (ищем	0)
    163	000000A1  8B FE			     MOV EDI, ESI
    164	000000A3  32 C0			     XOR AL, AL
    165	000000A5  B9 FFFFFFFF		     MOV ECX, 0FFFFFFFFh
    166	000000AA  F2> AE		     REPNE SCASB
    167	000000AC  F7 D1			     NOT ECX
    168	000000AE  49			     DEC ECX	     ; В ECX длина строки
    169
    170					     ; Вывод
    171	000000AF  6A 00			     PUSH 0		 ; Reserved
Turbo Assembler	 Version 5.0	    11-19-25 15:31:12	    Page 4
lab_9.asm



    172	000000B1  68 000000BEr		     PUSH OFFSET BytesWritten
    173	000000B6  51			     PUSH ECX		 ; Длина
    174	000000B7  56			     PUSH ESI		 ; Адрес буфера
    175	000000B8  FF 35	000000A8r	     PUSH hStdOut	 ; Handle
    176	000000BE  E8 00000000e		     CALL WriteConsole
1   177	000000C3  C3				 RET	 00000h
    178	000000C4			 PrintStr ENDP
    179
    180					 ; ---------------------------------------------------------
    181					 ; ПРОЦЕДУРА: ReadNum
    182					 ; Считывает строку и преобразует в	число (EAX)
    183					 ; Упрощенная	версия: работает с 1-2 цифрами
    184					 ; ---------------------------------------------------------
    185	000000C4			 ReadNum PROC
    186					     ; Чтение строки
    187	000000C4  6A 00			     PUSH 0		 ; Reserved
    188	000000C6  68 000000BAr		     PUSH OFFSET BytesRead
    189	000000CB  6A 05			     PUSH 5		 ; Максимум символов
    190	000000CD  68 000000B0r		     PUSH OFFSET ReadBuf ; Куда читать
    191	000000D2  FF 35	000000ACr	     PUSH hStdIn	 ; Handle
    192	000000D8  E8 00000000e		     CALL ReadConsole
    193
    194					     ; Преобразование ASCII в Число	(ATOI)
    195	000000DD  33 C0			     XOR EAX, EAX    ; Результат
    196	000000DF  33 C9			     XOR ECX, ECX    ; Счетчик
    197	000000E1  BE 000000B0r		     MOV ESI, OFFSET ReadBuf
    198
    199	000000E6			 LoopParse:
    200	000000E6  8A 1E			     MOV BL, [ESI]
    201	000000E8  80 FB	0D		     CMP BL, 0Dh     ; Конец ввода (CR)
    202	000000EB  74 2D	90 90 90 90	     JE	EndParse
    203	000000F1  80 FB	0A		     CMP BL, 0Ah     ; Line Feed
    204	000000F4  74 24	90 90 90 90	     JE	EndParse
    205	000000FA  80 FB	30		     CMP BL, '0'     ; Проверка	на цифры
    206	000000FD  72 1B	90 90 90 90	     JB	EndParse
    207	00000103  80 FB	39		     CMP BL, '9'
    208	00000106  77 12	90 90 90 90	     JA	EndParse
    209
    210	0000010C  80 EB	30		     SUB BL, '0'     ; '0' -> 0
    211	0000010F  6B C0	0A		     IMUL EAX, 10    ; Сдвиг разряда
    212	00000112  0F B6	DB		     MOVZX EBX,	BL
    213	00000115  03 C3			     ADD EAX, EBX    ; Добавление цифры
    214
    215	00000117  46			     INC ESI
    216	00000118  EB CC			     JMP LoopParse
    217
    218	0000011A			 EndParse:
1   219	0000011A  C3				 RET	 00000h
    220	0000011B			 ReadNum ENDP
    221
    222					 END Start
Turbo Assembler	 Version 5.0	    11-19-25 15:31:12	    Page 5
Symbol Table




Symbol Name			  Type	 Value

??date				  Text	 "11-19-25"
??filename			  Text	 "lab_9	  "
??time				  Text	 "15:31:12"
??version			  Number 0500
@32Bit				  Text	 1
@CodeSize			  Text	 0
@Cpu				  Text	 0F0FH
@DataSize			  Text	 0
@FileName			  Text	 lab_9
@Interface			  Text	 003h
@Model				  Text	 1
@WordSize			  Text	 4
@code				  Text	 FLAT
@curseg				  Text	 _TEXT
@data				  Text	 FLAT
@stack				  Text	 FLAT
BytesRead			  Dword	 FLAT:00BA
BytesWritten			  Dword	 FLAT:00BE
EndParse			  Near32 FLAT:011A
ExitApp				  Near32 FLAT:0097
ExitProcess			  Near16 ----:---- Extern
GetStdHandle			  Near16 ----:---- Extern
LoopParse			  Near32 FLAT:00E6
NULL				  Number 0000
PrintStr			  Near32 FLAT:009E
ReadBuf				  Byte	 FLAT:00B0
ReadConsole			  Alias	 ReadConsoleA
ReadConsoleA			  Near16 ----:---- Extern
ReadNum				  Near32 FLAT:00C4
SPIF_SENDCHANGE			  Number 0002
SPI_SETKEYBOARDDELAY		  Number 0017
SPI_SETKEYBOARDSPEED		  Number 000B
STD_INPUT_HANDLE		  Number -000A
STD_OUTPUT_HANDLE		  Number -000B
ShowError			  Near32 FLAT:008D
Start				  Near32 FLAT:0000
SystemParametersInfo		  Alias	 SystemParametersInfoA
SystemParametersInfoA		  Near16 ----:---- Extern
ValDelay			  Dword	 FLAT:00C2
ValSpeed			  Dword	 FLAT:00C6
WriteConsole			  Alias	 WriteConsoleA
WriteConsoleA			  Near16 ----:---- Extern
hStdIn				  Dword	 FLAT:00AC
hStdOut				  Dword	 FLAT:00A8
msgDelay			  Byte	 FLAT:0022
msgDone				  Byte	 FLAT:0068
msgError			  Byte	 FLAT:008B
msgSpeed			  Byte	 FLAT:0046
msgTitle			  Byte	 FLAT:0000
Turbo Assembler	 Version 5.0	    11-19-25 15:31:12	    Page 6
Symbol Table




Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  32  00CA Dword  Public  DATA
FLAT				  Group
_TEXT				  32  011B Dword  Public  CODE
