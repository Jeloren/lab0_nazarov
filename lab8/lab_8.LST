Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 1
lab_8.asm



      1					 include lab_8.inc
1     2					 ; lab_8.inc
1     3					 includelib import32.lib
1     4
1     5					 extrn ExitProcess:near
1     6					 extrn GetCommandLineA:near
1     7					 extrn MoveFileExA:near
1     8					 extrn GetLastError:near
1     9					 ; extrn GetStdHandle:near
1    10					 ; extrn WriteConsoleA:near
1    11					 extrn WriteFile:near
1    12					 extrn CreateFileA:near
1    13
     14
     15					 .386
     16	00000000			 .model	FLAT, STDCALL
     17
     18					 ; Константы
     19		  =0001			 TRUE  EQU 1
     20		  =0000			 FALSE EQU 0
     21		  =0022			 QUOTE EQU 22H ; "
     22		  =0020			 SPACE EQU 20H ; Пробел
     23		  =0009			 TAB   EQU 09H ; Табуляция
     24		  =0000			 NULL  EQU 0
     25		  =0001			 MOVEFILE_REPLACE_EXISTING EQU 1
     26		  =40000000		 GENERIC_WRITE	  EQU 40000000h
     27		  =0003			 OPEN_EXISTING	  EQU 3
     28		  =0002			 FILE_SHARE_WRITE EQU 2
     29	00000000			 .DATA
     30	00000000  0104*(00)		     SourcePath	DB 260 DUP (0)
     31	00000104  0104*(00)		     NewPath	DB 260 DUP (0)
     32	00000208  0A*(00)		     FlagBuf	DB 10  DUP (0)
     33
     34					     ; --- Переменные	для консоли ---
     35	00000212  ????????		     hStdOut	  DD ?		    ; Хранитель дескриптора		    +
     36					 консоли
     37	00000216  ????????		     BytesWritten DD ?		    ; Сюда WriteConsole запишет сколько   +
     38					 байт вывела
     39	0000021A  43 4F	4E 4F 55 54 24+	     ConOutName	  DB "CONOUT$",	0   ; Имя файла	консоли вывода
     40		  00
     41
     42					     ; --- Сообщения ---
     43	00000222  4F 4B	3A 20 46 69 6C+	     MsgSuccess	  DB "OK: File moved successfully.", 0Dh, 0Ah, 0
     44		  65 20	6D 6F 76 65 64+
     45		  20 73	75 63 63 65 73+
     46		  73 66	75 6C 6C 79 2E+
     47		  0D 0A	00
     48	00000241  46 41	49 4C 3A 20 53+	     MsgSrcError  DB "FAIL: Source file	not found.", 0Dh, 0Ah, 0
     49		  6F 75	72 63 65 20 66+
     50		  69 6C	65 20 6E 6F 74+
     51		  20 66	6F 75 6E 64 2E+
     52		  0D 0A	00
     53	00000260  46 41	49 4C 3A 20 54+	     MsgExistErr  DB "FAIL: Target file	exists (use flag 1 to overwrite).", 0Dh, 0Ah, 0
     54		  61 72	67 65 74 20 66+
     55		  69 6C	65 20 65 78 69+
     56		  73 74	73 20 28 75 73+
     57		  65 20	66 6C 61 67 20+
Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 2
lab_8.asm



     58		  31 20	74 6F 20 6F 76+
     59		  65 72	77 72 69 74 65+
     60		  29 2E	0D 0A 00
     61	00000296  46 41	49 4C 3A 20 49+	     MsgPathErr	  DB "FAIL: Invalid paths or access denied.", 0Dh, 0Ah,	0
     62		  6E 76	61 6C 69 64 20+
     63		  70 61	74 68 73 20 6F+
     64		  72 20	61 63 63 65 73+
     65		  73 20	64 65 6E 69 65+
     66		  64 2E	0D 0A 00
     67	000002BE  46 41	49 4C 3A 20 55+	     MsgUnknown	  DB "FAIL: Unknown system error.", 0Dh, 0Ah, 0
     68		  6E 6B	6E 6F 77 6E 20+
     69		  73 79	73 74 65 6D 20+
     70		  65 72	72 6F 72 2E 0D+
     71		  0A 00
     72
     73	000002DC			 .CODE
     74	00000000			 START:
     75					     ; --- Открываем CONOUT$ через CreateFile ---
     76	00000000  6A 00			     PUSH 0		      ;	hTemplateFile
     77	00000002  6A 00			     PUSH 0		      ;	dwFlagsAndAttributes
     78	00000004  6A 03			     PUSH OPEN_EXISTING	      ;	dwCreationDisposition
     79	00000006  6A 00			     PUSH 0		      ;	lpSecurityAttributes
     80	00000008  6A 02			     PUSH FILE_SHARE_WRITE    ;	dwShareMode
     81	0000000A  68 40000000		     PUSH GENERIC_WRITE	      ;	dwDesiredAccess
     82	0000000F  68 0000021Ar		     PUSH OFFSET ConOutName   ;	lpFileName
     83	00000014  E8 00000000e		     CALL CreateFileA
     84	00000019  A3 00000212r		     MOV hStdOut, EAX	      ;	Сохраняем дескриптор
     85
     86					     ; --- 1. Получение командной строки ---
     87	0000001E  E8 00000000e		     CALL GetCommandLineA
     88	00000023  8B F0			     MOV ESI, EAX
     89
     90					     ; =============================================================
     91					     ; ПАРСИНГ АРГУМЕНТОВ
     92					     ; =============================================================
     93	00000025  E8 0000018F		     CALL Skip_Whitespace
     94	0000002A  80 3E	22		     CMP BYTE PTR [ESI], QUOTE
     95	0000002D  75 20	90 90 90 90	     JNE Skip_Prog_NoQuote
     96	00000033  46			     INC ESI
     97	00000034			 Skip_Prog_Quote_Loop:
     98	00000034  8A 06			     MOV AL, [ESI]
     99	00000036  3C 00			     CMP AL, NULL
    100	00000038  74 7A	90 90 90 90	     JE	 Parse_Args_Done
    101	0000003E  3C 22			     CMP AL, QUOTE
    102	00000040  74 07	90 90 90 90	     JE	 Skip_Prog_Quote_End
    103	00000046  46			     INC ESI
    104	00000047  EB EB			     JMP Skip_Prog_Quote_Loop
    105	00000049			 Skip_Prog_Quote_End:
    106	00000049  46			     INC ESI
    107	0000004A  EB 20	90 90 90	     JMP Parse_Arg_1
    108	0000004F			 Skip_Prog_NoQuote:
    109	0000004F  8A 06			     MOV AL, [ESI]
    110	00000051  3C 00			     CMP AL, NULL
    111	00000053  74 5F	90 90 90 90	     JE	 Parse_Args_Done
    112	00000059  3C 20			     CMP AL, SPACE
    113	0000005B  74 0F	90 90 90 90	     JE	 Parse_Arg_1
    114	00000061  3C 09			     CMP AL, TAB
Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 3
lab_8.asm



    115	00000063  74 07	90 90 90 90	     JE	 Parse_Arg_1
    116	00000069  46			     INC ESI
    117	0000006A  EB E3			     JMP Skip_Prog_NoQuote
    118
    119	0000006C			 Parse_Arg_1:
    120	0000006C  E8 00000148		     CALL Skip_Whitespace
    121	00000071  80 3E	00		     CMP BYTE PTR [ESI], NULL
    122	00000074  74 3E	90 90 90 90	     JE	Parse_Args_Done
    123	0000007A  BF 00000000r		     MOV EDI, OFFSET SourcePath
    124	0000007F  E8 0000014B		     CALL Parse_Token
    125
    126	00000084			 Parse_Arg_2:
    127	00000084  E8 00000130		     CALL Skip_Whitespace
    128	00000089  80 3E	00		     CMP BYTE PTR [ESI], NULL
    129	0000008C  74 26	90 90 90 90	     JE	Parse_Args_Done
    130	00000092  BF 00000104r		     MOV EDI, OFFSET NewPath
    131	00000097  E8 00000133		     CALL Parse_Token
    132
    133	0000009C			 Parse_Arg_3:
    134	0000009C  E8 00000118		     CALL Skip_Whitespace
    135	000000A1  80 3E	00		     CMP BYTE PTR [ESI], NULL
    136	000000A4  74 0E	90 90 90 90	     JE	Parse_Args_Done
    137	000000AA  BF 00000208r		     MOV EDI, OFFSET FlagBuf
    138	000000AF  E8 0000011B		     CALL Parse_Token
    139
    140	000000B4			 Parse_Args_Done:
    141
    142					     ; --- 2. ПРОВЕРКА ПУТЕЙ ---
    143	000000B4  80 3D	00000000r 00	     CMP BYTE PTR [SourcePath],	0
    144	000000BB  74 52	90 90 90 90	     JE	Handle_Path_Error
    145	000000C1  80 3D	00000104r 00	     CMP BYTE PTR [NewPath], 0
    146	000000C8  74 45	90 90 90 90	     JE	Handle_Path_Error
    147
    148					     ; --- 3. ЛОГИКА ФЛАГА ---
    149	000000CE  BA 00000000		     MOV EDX, 0
    150	000000D3  A0 00000208r		     MOV AL, [FlagBuf]
    151	000000D8  3C 31			     CMP AL, '1'
    152	000000DA  75 09	90 90 90 90	     JNE Do_Move
    153	000000E0  BA 00000001		     MOV EDX, MOVEFILE_REPLACE_EXISTING
    154
    155	000000E5			 Do_Move:
    156	000000E5  52			     PUSH EDX
    157	000000E6  68 00000104r		     PUSH OFFSET NewPath
    158	000000EB  68 00000000r		     PUSH OFFSET SourcePath
    159	000000F0  E8 00000000e		     CALL MoveFileExA
    160
    161	000000F5  83 F8	00		     CMP EAX, 0
    162	000000F8  74 26	90 90 90 90	     JE	Handle_Move_Error    ; Если	0 - ошибка, идем разбираться   +
    163					 какая
    164
    165					     ; --- УСПЕХ ---
    166	000000FE  B8 00000222r		     MOV EAX, OFFSET MsgSuccess
    167	00000103  E8 00000086		     CALL PrintStr
    168
    169	00000108  6A 00			     PUSH 0
    170	0000010A  E8 00000000e		     CALL ExitProcess
    171
Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 4
lab_8.asm



    172					 ; =============================================================
    173					 ; ОБРАБОТКА ОШИБОК
    174					 ; =============================================================
    175
    176	0000010F			 Handle_Path_Error:
    177	0000010F  B8 00000296r		     MOV EAX, OFFSET MsgPathErr
    178	00000114  E8 00000075		     CALL PrintStr
    179	00000119  6A 01			     PUSH 1
    180	0000011B  E8 00000000e		     CALL ExitProcess
    181
    182	00000120			 Handle_Move_Error:
    183	00000120  E8 00000000e		     CALL GetLastError	 ; Код ошибки в EAX
    184
    185					     ; Проверка: Файл не найден (Код 2)
    186	00000125  83 F8	02		     CMP EAX, 2
    187	00000128  74 30	90 90 90 90	     JE	Err_Source_Missing
    188
    189					     ; Проверка: Путь не найден (Код 3)
    190	0000012E  83 F8	03		     CMP EAX, 3
    191	00000131  74 27	90 90 90 90	     JE	Err_Source_Missing
    192
    193					     ; Проверка: Файл существует (Код 183 = 0B7h)
    194	00000137  3D 000000B7		     CMP EAX, 0B7h
    195	0000013C  74 2B	90 90 90 90	     JE	Err_Target_Exists
    196
    197					     ; Проверка: Отказано в доступе (Код 5)
    198	00000142  83 F8	05		     CMP EAX, 5
    199	00000145  74 31	90 90 90 90	     JE	Err_Path_Access
    200
    201					     ; Иначе неизвестная ошибка
    202	0000014B  B8 000002BEr		     MOV EAX, OFFSET MsgUnknown
    203	00000150  E8 00000039		     CALL PrintStr
    204	00000155  EB 30	90 90 90	     JMP Final_Err_Exit
    205
    206	0000015A			 Err_Source_Missing:
    207	0000015A  B8 00000241r		     MOV EAX, OFFSET MsgSrcError
    208	0000015F  E8 0000002A		     CALL PrintStr
    209	00000164  EB 21	90 90 90	     JMP Final_Err_Exit
    210
    211	00000169			 Err_Target_Exists:
    212	00000169  B8 00000260r		     MOV EAX, OFFSET MsgExistErr
    213	0000016E  E8 0000001B		     CALL PrintStr
    214	00000173  EB 12	90 90 90	     JMP Final_Err_Exit
    215
    216	00000178			 Err_Path_Access:
    217	00000178  B8 00000296r		     MOV EAX, OFFSET MsgPathErr
    218	0000017D  E8 0000000C		     CALL PrintStr
    219	00000182  EB 03	90 90 90	     JMP Final_Err_Exit
    220
    221	00000187			 Final_Err_Exit:
    222	00000187  6A 01			     PUSH 1
    223	00000189  E8 00000000e		     CALL ExitProcess
    224
    225
    226					 ; =============================================================
    227					 ; ПРОЦЕДУРЫ ПОМОЩНИКИ
    228					 ; =============================================================
Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 5
lab_8.asm



    229
    230					 ; --- Процедура вывода строки на экран ---
    231					 ; Вход: EAX - адрес строки
    232	0000018E			 PrintStr PROC
    233	0000018E  57			     PUSH EDI
    234	0000018F  56			     PUSH ESI
    235	00000190  51			     PUSH ECX
    236
    237	00000191  8B F0			     MOV ESI, EAX    ; Сохраняем адрес строки
    238
    239					     ; Подсчет длины строки
    240	00000193  8B F8			     MOV EDI, EAX
    241	00000195  32 C0			     xor AL, AL
    242	00000197  B9 FFFFFFFF		     MOV ECX, -1
    243	0000019C  F2> AE		     REPNE SCASB     ; Ищем	0
    244	0000019E  F7 D1			     NOT ECX
    245	000001A0  49			     DEC ECX	     ; В ECX теперь длина строки
    246
    247					     ; Вывод: WriteFile(hFile, lpBuffer, nBytes, lpBytesWritten, lpOverlapped)
    248	000001A1  6A 00			     PUSH 0		      ;	lpOverlapped (0)
    249	000001A3  68 00000216r		     PUSH OFFSET BytesWritten ;	Куда записать кол-во байт
    250	000001A8  51			     PUSH ECX		      ;	Длина
    251	000001A9  56			     PUSH ESI		      ;	Адрес текста
    252	000001AA  FF 35	00000212r	     PUSH hStdOut	      ;	Хендл (от CreateFile)
    253	000001B0  E8 00000000e		     CALL WriteFile
    254
    255	000001B5  59			     POP ECX
    256	000001B6  5E			     POP ESI
    257	000001B7  5F			     POP EDI
1   258	000001B8  C3				 RET	 00000h
    259	000001B9			 PrintStr ENDP
    260
    261	000001B9			 Skip_Whitespace PROC
    262	000001B9			 Skip_WS_Loop:
    263	000001B9  8A 06			     MOV AL, [ESI]
    264	000001BB  3C 20			     CMP AL, SPACE
    265	000001BD  74 0D	90 90 90 90	     JE	 Skip_WS_Next
    266	000001C3  3C 09			     CMP AL, TAB
    267	000001C5  74 05	90 90 90 90	     JE	 Skip_WS_Next
1   268	000001CB  C3				 RET	 00000h
    269	000001CC			 Skip_WS_Next:
    270	000001CC  46			     INC ESI
    271	000001CD  EB EA			     JMP Skip_WS_Loop
    272	000001CF			 Skip_Whitespace ENDP
    273
    274	000001CF			 Parse_Token PROC
    275	000001CF  80 3E	22		     CMP BYTE PTR [ESI], QUOTE
    276	000001D2  75 23	90 90 90 90	     JNE Parse_Token_Simple
    277	000001D8  46			     INC ESI
    278	000001D9			 Parse_Token_Quote_Loop:
    279	000001D9  8A 06			     MOV AL, [ESI]
    280	000001DB  3C 00			     CMP AL, NULL
    281	000001DD  74 38	90 90 90 90	     JE	 Parse_Token_End
    282	000001E3  3C 22			     CMP AL, QUOTE
    283	000001E5  74 0A	90 90 90 90	     JE	 Parse_Token_Quote_Done
    284	000001EB  88 07			     MOV [EDI],	AL
    285	000001ED  46			     INC ESI
Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 6
lab_8.asm



    286	000001EE  47			     INC EDI
    287	000001EF  EB E8			     JMP Parse_Token_Quote_Loop
    288	000001F1			 Parse_Token_Quote_Done:
    289	000001F1  46			     INC ESI
    290	000001F2  EB 23	90 90 90	     JMP Parse_Token_End
    291	000001F7			 Parse_Token_Simple:
    292	000001F7  8A 06			     MOV AL, [ESI]
    293	000001F9  3C 00			     CMP AL, NULL
    294	000001FB  74 1A	90 90 90 90	     JE	 Parse_Token_End
    295	00000201  3C 20			     CMP AL, SPACE
    296	00000203  74 12	90 90 90 90	     JE	 Parse_Token_End
    297	00000209  3C 09			     CMP AL, TAB
    298	0000020B  74 0A	90 90 90 90	     JE	 Parse_Token_End
    299	00000211  88 07			     MOV [EDI],	AL
    300	00000213  46			     INC ESI
    301	00000214  47			     INC EDI
    302	00000215  EB E0			     JMP Parse_Token_Simple
    303	00000217			 Parse_Token_End:
    304	00000217  C6 07	00		     MOV BYTE PTR [EDI], 0
1   305	0000021A  C3				 RET	 00000h
    306	0000021B			 Parse_Token ENDP
    307
    308					 END START
Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 7
Symbol Table




Symbol Name			  Type	 Value

??date				  Text	 "11-24-25"
??filename			  Text	 "lab_8	  "
??time				  Text	 "08:54:00"
??version			  Number 0500
@32Bit				  Text	 1
@CodeSize			  Text	 0
@Cpu				  Text	 0F0FH
@DataSize			  Text	 0
@FileName			  Text	 lab_8
@Interface			  Text	 003h
@Model				  Text	 1
@WordSize			  Text	 4
@code				  Text	 FLAT
@curseg				  Text	 _TEXT
@data				  Text	 FLAT
@stack				  Text	 FLAT
BytesWritten			  Dword	 FLAT:0216
ConOutName			  Byte	 FLAT:021A
CreateFileA			  Near16 ----:---- Extern
Do_Move				  Near32 FLAT:00E5
Err_Path_Access			  Near32 FLAT:0178
Err_Source_Missing		  Near32 FLAT:015A
Err_Target_Exists		  Near32 FLAT:0169
ExitProcess			  Near16 ----:---- Extern
FALSE				  Number 0000
FILE_SHARE_WRITE		  Number 0002
Final_Err_Exit			  Near32 FLAT:0187
FlagBuf				  Byte	 FLAT:0208
GENERIC_WRITE			  Number 40000000
GetCommandLineA			  Near16 ----:---- Extern
GetLastError			  Near16 ----:---- Extern
Handle_Move_Error		  Near32 FLAT:0120
Handle_Path_Error		  Near32 FLAT:010F
MOVEFILE_REPLACE_EXISTING	  Number 0001
MoveFileExA			  Near16 ----:---- Extern
MsgExistErr			  Byte	 FLAT:0260
MsgPathErr			  Byte	 FLAT:0296
MsgSrcError			  Byte	 FLAT:0241
MsgSuccess			  Byte	 FLAT:0222
MsgUnknown			  Byte	 FLAT:02BE
NULL				  Number 0000
NewPath				  Byte	 FLAT:0104
OPEN_EXISTING			  Number 0003
Parse_Arg_1			  Near32 FLAT:006C
Parse_Arg_2			  Near32 FLAT:0084
Parse_Arg_3			  Near32 FLAT:009C
Parse_Args_Done			  Near32 FLAT:00B4
Parse_Token			  Near32 FLAT:01CF
Parse_Token_End			  Near32 FLAT:0217
Parse_Token_Quote_Done		  Near32 FLAT:01F1
Parse_Token_Quote_Loop		  Near32 FLAT:01D9
Parse_Token_Simple		  Near32 FLAT:01F7
PrintStr			  Near32 FLAT:018E
QUOTE				  Number 0022
Turbo Assembler	 Version 5.0	    11-24-25 08:54:00	    Page 8
Symbol Table



SPACE				  Number 0020
START				  Near32 FLAT:0000
Skip_Prog_NoQuote		  Near32 FLAT:004F
Skip_Prog_Quote_End		  Near32 FLAT:0049
Skip_Prog_Quote_Loop		  Near32 FLAT:0034
Skip_WS_Loop			  Near32 FLAT:01B9
Skip_WS_Next			  Near32 FLAT:01CC
Skip_Whitespace			  Near32 FLAT:01B9
SourcePath			  Byte	 FLAT:0000
TAB				  Number 0009
TRUE				  Number 0001
WriteFile			  Near16 ----:---- Extern
hStdOut				  Dword	 FLAT:0212

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  32  02DC Dword  Public  DATA
FLAT				  Group
_TEXT				  32  021B Dword  Public  CODE
